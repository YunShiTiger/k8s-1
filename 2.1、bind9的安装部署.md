

# 安装部署BIND9

## 操作系统版本和内核版本

```
#cat /etc/redhat-release 
CentOS Linux release 7.6.1810 (Core)

#uname -a
Linux node 3.10.0-862.el7.x86_64 #1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```

## 使用yum安装BIND9

```
yum install bind -y
```

安装的版本为`9.9.4`

## BIND9主配置文件/etc/named.conf

1. 主配置文件的格式

   ```
   options{
        //全局选项
   }
   zone　"zone name" {
      //定于区域
   }
   logging{
       //日志文件
   }
   include：加载别的文件
   ```

2. 主配置文件的配置注意事项

   > - 语法严格，分号，空格
   > - 文件的权限，属主：root，属组：named，640

3. 主配置文件范例

   ```
   options {
   	listen-on port 53 { 10.0.0.20; };
   	directory 	"/var/named";
   	dump-file 	"/var/named/data/cache_dump.db";
   	statistics-file "/var/named/data/named_stats.txt";
   	memstatistics-file "/var/named/data/named_mem_stats.txt";
   	allow-query     { any; };
   	forwarders      { 10.0.0.254; };
   
   	/* 
   	 - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
   	 - If you are building a RECURSIVE (caching) DNS server, you need to enable 
   	   recursion. 
   	 - If your recursive DNS server has a public IP address, you MUST enable access 
   	   control to limit queries to your legitimate users. Failing to do so will
   	   cause your server to become part of large scale DNS amplification 
   	   attacks. Implementing BCP38 within your network would greatly
   	   reduce such attack surface 
   	*/
   	recursion yes;
   	
   		dnssec-enable no;
   		dnssec-validation no;
   
   	/* Path to ISC DLV key */
   	bindkeys-file "/etc/named.iscdlv.key";
   
   	managed-keys-directory "/var/named/dynamic";
   
   	pid-file "/run/named/named.pid";
   	session-keyfile "/run/named/session.key";
   };
   
   
   logging {
           channel default_debug {
                   file "data/named.run";
                   severity dynamic;
           };
   };
   
   zone "." IN {
   	type hint;
   	file "named.ca";
   };
   
   include "/etc/named.rfc1912.zones";
   include "/etc/named.root.key";
   ```

## 区域配置文件

在/etc/named.rfc1912.zones添加

```
zone "host.com" IN {
        type  master;
        file  "host.com.zone";
        allow-update { 10.0.0.20; };
};

zone "wzxmt.com" IN {
        type  master;
        file  "wzxmt.com.zone";
        allow-update { 10.0.0.20; };
};
```

这里自定义了一个host.com的主机域，可以放在/etc/named.rfc1912.zones文件中，也可以放置在自定义的文件中，在/etc/named.conf里include进来

> 主机域
>
> - 主机域和业务域无关，且建议分开
> - 主机域其实是一个假域，也就是说，主机域其实是不能解析到互联网上的，它只对局域网（内网）提供服务

## 自定义区域数据库文件

- 一般而言是文本文件，且只包含**资源记录**、**宏定义**和**注释**
- 需在自定义区域配置文件中指定存放路径，可以绝对路径或相对路径（相对于/var/named目录）
- 注意文件的属性（属主、属组及权限）
- 每次添加解析，需要滚动更新serial值

## 配置范例

```
$TTL 600	; 10 minutes
@       		IN SOA	dns.host.com. dnsadmin.host.com. (
				2020051701 ; serial
				10800      ; refresh (3 hours)
				900        ; retry (15 minutes)
				604800     ; expire (1 week)
				86400      ; minimum (1 day)
				)
			NS   dns.host.com.
$ORIGIN host.com.
$TTL 60	; 1 minute
dns      	        A    10.0.0.20
manege      	        A    10.0.0.20
m1      	        A    10.0.0.31
m2      	        A    10.0.0.32
m3      	        A    10.0.0.33
n1      	        A    10.0.0.41
n2      	        A    10.0.0.42
n3      	        A    10.0.0.43
```

## 资源记录（Resource Record）

### 资源记录格式

复制

```
name [ttl(缓存时间)] IN 资源记录类型（RRtype）  Value
```

### 常用资源记录类型（RR-type）

#### SOA记录

SOA: 起始授权，只能有一条

- name:只能是区域名称，通常可以简写为@，例如：od.com.

- value:有n个数值，最主要的是主DNS服务器的FQDN，点不可省略

  注意

  ：SOA必须是区域数据库文件第一条记录

  > 例子：
  >
  > ```
  >@ 600 IN SOA  dns.host.com. 管理员邮箱（dnsadmin.host.com.）（
  >   序列号(serial number) ;注释内容，十进制数据，不能超过10位，通常使用日期时间戳，例如2018121601
  >   刷新时间(refresh time) ;即每隔多久到主服务器检查一次
  >      重试时间(retry time) ;应该小于refresh time
  >      过期时间(expire time);当辅助DNS服务器无法联系上主DNS服务器时，辅助DNS服务器可以在多长时间内认为其缓存是有效的，并供用户查询。
  >      netgative answer ttl ;非权威应答的ttl，缓存DNS服务器可以缓存记录多长时间
  >    ）
  >    ```

#### NS记录

NS：可以有多条，每一个NS记录，**必须**对应一个A记录

- name:区域名称，通常可以简写为@

- value:DNS服务器的FQDN(可以使用相对名称)

  > 例子：
  >
  > ```
  >@ 600 IN NS ns1
  > ```

#### A记录

A：只能定义在正向区域数据库文件中（ipv4->FQDN）

- name:FQDN（可以使用相对名称)

- value:IP

  > 例子：
  >
  > ```
  >www  600(单位s) IN A 10.0.0.11
  > www  600(单位s) IN A 10.0.0.12
  > ```

**注** 可以做轮询

#### MX记录

MX:邮件交换记录，可以有多个（用的不多）

- name:区域名称，用于标识smtp服务器

- value:包含优先级和FQDN

- 优先级:0-99，数字越小，级别越高，

  > 例子：
  >
  > ```
  >@ 600 IN MX 10 mail
  > @ 600 IN MX 20 smtp
  > ```

#### CNAME记录

CNAME：canonical name，别名（FQDN->FQDN）

- name ：FQDN

- value :FQDN

  > 例子：
  >
  > ```
  >eshop IN CNAME www
  > ```

### 宏定义

- $ORIGIN .
- $TTL 60

### 注释

区域数据库文件中使用`;`（分号）来进行注释

## 启动

### 检查配置文件

```
named-checkconf
```

没有报错就是正常的

### 启动BIND9服务

```
systemctl start named
```

### 检查BIND9服务状态

```
systemctl status named
```

这样就完成了一个最基本的转发DNS的部署，它可以为我们的内网客户端提供DNS递归查询，例如查询并返回`www.baidu.com`的解析结果。

## 验证解析

### 配置DNS服务器指向

在/etc/resole里配置DNS服务器的ip地址为我们部署的主机ip

```
cat /etc/resolv.conf    
Generated by NetworkManager
nameserver 10.0.0.20
```

### 验证解析

```bash
ping baidu.com
```