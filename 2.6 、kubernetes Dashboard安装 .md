## kubernetes Dashboard安装

gihub:

```bash
https://github.com/kubernetes/dashboard/releases
```

#### 1.1 下载 Dashboard yaml 文件 

```bash
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0-beta6/aio/deploy/recommended.yaml
```

#### 1.2 修改配置文件内容

修改recommended.yaml, 暴露出去 Dashboard 端口，方便外部访问。 

```bash
---

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort     #新增
  ports:
    - port: 443
      targetPort: 8443
      nodePort: 30000  #新增
  selector:
    k8s-app: kubernetes-dashboard

---
#自动生成的证书很多浏览器无法使用(只能使用一个月)，需要创建，注释kubernetes-dashboard-certs对象声明
---

#apiVersion: v1
#kind: Secret
#metadata:
#  labels:
#    k8s-app: kubernetes-dashboard
#  name: kubernetes-dashboard-certs
#  namespace: kubernetes-dashboard
#type: Opaque

---
```

#### 1.3 配置证书,生成kubernetes-dashboard-certs

```bash
mkdir dashboard-certs
cd dashboard-certs/
#创建命名空间
kubectl create namespace kubernetes-dashboard
# 创建key文件
openssl genrsa -out dashboard.key 2048
#证书请求
openssl req -days 36000 -new -out dashboard.csr -key dashboard.key -subj '/CN=dashboard-cert'
#自签证书
openssl x509 -req -in dashboard.csr -signkey dashboard.key -out dashboard.crt
#创建kubernetes-dashboard-certs对象
kubectl create secret generic kubernetes-dashboard-certs --from-file=dashboard.key --from-file=dashboard.crt -n kubernetes-dashboard
```

#### 1.4 安装Dashboard

```bash
在安装新Beta之前，请通过删除其名称空间来删除以前的版本：
kubectl delete ns kubernetes-dashboard
#安装 
kubectl create -f  recommended.yaml 
#如果镜像不能pull下来,可以通过github下载,然后倒入使用(建议)
wget https://github.com/kubernetes/dashboard/archive/v2.0.0-beta6.tar.gz
cat dashboard-2.0.0-beta6.tar_2.gz | docker import - kubernetesui/dashboard:v2.0.0-beta6
#检查结果
kubectl get pods -A  -o wide
#Dashboard需要master和node直接网络通讯正常才能使用，需要coredns、kube-flannel-ds保持running状态才能正常运行，如果dashboard无法访问，需要先查看这些pod是否正常。
kubectl get services -n kubernetes-dashboard -o wide
NAME                        TYPE        CLUSTER-IP    EXTERNAL-IP   PORT(S)         AGE   SELECTOR
dashboard-metrics-scraper   ClusterIP   10.1.206.17   <none>        8000/TCP        17m   k8s-app=dashboard-metrics-scraper
kubernetes-dashboard        NodePort    10.1.147.83   <none>        443:30000/TCP   17m   k8s-app=kubernetes-dashboard

```

#### 1.5 创建用户和角色绑定,查看Token

创建管理员账号

```bash
cat << EOF >dashboard-adminuser.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: dashboard-admin
  namespace: kubernetes-dashboard
EOF
kubectl create -f dashboard-adminuser.yaml
```

为用户分配权限

```bash
cat << EOF >dashboard-admin-bind-cluster-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin-bind-cluster-role
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: dashboard-admin
  namespace: kubernetes-dashboard
EOF
kubectl create -f dashboard-admin-bind-cluster-role.yaml
```

 查看并复制用户Token： 

```bash
kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep dashboard-admin | awk '{print $1}')|grep token
```

 访问：[https://10.0.0.31:30000](https://10.0.0.31:30000)，选择Token登录，输入刚才复制的密钥： 

#### 1.6 配置查看资源

登录成功后命名空间选择kube-system,可以查看Pods信息, 因为没有安装metrics-server所以Pods的CPU、内存情况是看不到的。(heapster已经被metrics-server取代) 

**安装metrics-server**

kubernetes有一个HPA(Horizontal Pod Autoscaler)的资源，可以实现基于CPU使用率的Pod自动伸缩的功能。HPA基于Master Node上的kube-controller-manager服务启动参数–horizontal-pod-autoscaler-sync-period定义的时长(默认为30秒)，周期性的检测Pod的CPU使用率(需要事先安装heapster)。

- 在Node节点上下载镜像文件：

```bash
docker pull bluersw/metrics-server-amd64:v0.3.6
docker tag bluersw/metrics-server-amd64:v0.3.6 k8s.gcr.io/metrics-server-amd64:v0.3.6  
```

- 在Master上执行安装：
  在[Kubernetes Metrics Server](https://github.com/kubernetes-incubator/metrics-server)下载metrics-server

  ```bash
  git clone https://github.com/kubernetes-incubator/metrics-server
  cd metrics-server/deploy/kubernetes
  ```

修改配置：metrics-server-deployment.yaml

```yaml
. . .
      - name: metrics-server
        image: k8s.gcr.io/metrics-server-amd64:v0.3.6
        command：   #添加
        - /metrics-server #添加 metrics-server容器不能通过CoreDNS解析各Node主机名，metrics-server连节点时默认是连接节点的主机名
        - --kubelet-insecure-tls #添加  不验证客户端证书
        - --kubelet-preferred-address-types=InternalIP #添加
. . .
```

安装metrics-server

```
kubectl create -f ./
```

获取资源信息时报错了

```bash
kubectl top nodes
Error from server (ServiceUnavailable): the server is currently unable to handle the request (get nodes.metrics.k8s.io)
```

通过查看日志

```bash
journalctl -f -u kubelet.service
Nov 16 23:18:16 master01 kubelet[6340]: E1116 23:18:16.668989    6340 summary_sys_containers.go:82] Failed to get system container stats for "/system.slice/docker.service": failed to getcgroup stats for "/system.slice/docker.service": failed to get container info for "/system.slice/docker.service": unknown container "/system.slice/docker.service"
```

在kubelet配置文件10-kubeadm.conf中的 Environment中添加"--runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice"

```bash
sed -ri.bak "s#(.*)(kubelet\.conf)#\1\2 --runtime-cgroups=/systemd/system.slice --kubelet-cgroups=/systemd/system.slice#g" /usr/lib/systemd/system/kubelet.service.d/10-kubeadm.conf
```

每个节点按照相应配置即可,然后重启, 稍等一会儿,在web界面上能看到相应资源信息.

```bash
kubectl top node
NAME       CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
master01   94m          4%     1442Mi          50%
master02   95m          4%     1341Mi          47%
node01     19m          0%     835Mi           44%
node02     31m          1%     765Mi           40%
node03     28m          1%     884Mi           47%
```

