## kubernetes Dashboard安装

gihub:

```bash
https://github.com/kubernetes/dashboard/releases
```

#### 1.1 下载 Dashboard yaml 文件 

```bash
wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml
```

#### 1.2 修改配置文件内容

访问Dashboard有两种方式

修改recommended.yaml，通过nodeport方式暴露Dashboard 端口，方便外部访问。 

```bash
---

kind: Service
apiVersion: v1
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: kubernetes-dashboard
  namespace: kubernetes-dashboard
spec:
  type: NodePort     #新增
  ports:
    - port: 443
      targetPort: 8443
      nodePort: 30000  #新增
  selector:
    k8s-app: kubernetes-dashboard

---
#自动生成的证书很多浏览器无法使用(只能使用一个月)，需要创建，注释kubernetes-dashboard-certs对象声明
---

#apiVersion: v1
#kind: Secret
#metadata:
#  labels:
#    k8s-app: kubernetes-dashboard
#  name: kubernetes-dashboard-certs
#  namespace: kubernetes-dashboard
#type: Opaque

---
```

修改recommended.yaml，通过ingress方式，使用域名访问。

```yaml
#自动生成的证书很多浏览器无法使用(只能使用一个月)，需要创建，注释kubernetes-dashboard-certs对象声明
---

#apiVersion: v1
#kind: Secret
#metadata:
#  labels:
#    k8s-app: kubernetes-dashboard
#  name: kubernetes-dashboard-certs
#  namespace: kubernetes-dashboard
#type: Opaque
...       
          ports:
          - containerPort: 8443
            protocol: TCP
          command:  #添加
            - /dashboard #添加
          args:
            - --token-ttl=43200  #添加
            - --bind-address=0.0.0.0 #添加
            - --tls-cert-file=tls.crt #添加
            - --tls-key-file=tls.key  #添加
            - --auto-generate-certificates
            - --namespace=kubernetes-dashboard
            # Uncomment the following line to manually specify Kubernetes API server 
# 添加ingress方式访问
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: ingress-nginx-kubernetes-dashboard
  namespace: kubernetes-dashboard
  annotations:
    nginx.ingress.kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
    nginx.ingress.kubernetes.io/secure-backends: "true"
    nginx.ingress.kubernetes.io/ssl-passthrough: "true"
spec:
  tls:
    - hosts:
      - dashbor.wzxmt.com
      secretName: kubernetes-dashboard-certs
  rules:
    - host: dashbor.wzxmt.com
      http:
        paths:
        - path: /
          backend:
            serviceName: kubernetes-dashboard
            servicePort: 443
```

#### 1.3 配置证书,生成kubernetes-dashboard-certs

```bash
mkdir dashboard-certs && cd dashboard-certs/
#自签证书
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout wzxmt.com.key -out wzxmt.com.crt -subj "/CN=wzxmt.com"
#创建命名空间
kubectl create namespace kubernetes-dashboard
#创建kubernetes-dashboard-certs对象
kubectl create secret tls kubernetes-dashboard-certs -n kubernetes-dashboard --key wzxmt.com.key --cert wzxmt.com.crt
```

#### 1.4 安装Dashboard

```bash
在安装新Beta之前，请通过删除其名称空间来删除以前的版本：
kubectl delete ns kubernetes-dashboard
#安装 
kubectl create -f  recommended.yaml 
#如果镜像不能pull下来,可以通过github下载,然后倒入使用(建议)
wget https://github.com/kubernetes/dashboard/archive/v2.0.0.tar.gz
cat dashboard-2.0.0.tar.gz | docker import - kubernetesui/dashboard:v2.0.0
#检查结果
kubectl get pods -A  -o wide
#Dashboard需要master和node直接网络通讯正常才能使用，需要coredns、kube-flannel-ds保持running状态才能正常运行，如果dashboard无法访问，需要先查看这些pod是否正常。
[root@m1 ~]# kubectl get svc -n kubernetes-dashboard -o wide
NAME                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)         AGE   SELECTOR
dashboard-metrics-scraper   ClusterIP   10.96.63.241   <none>        8000/TCP        19h   k8s-app=dashboard-metrics-scraper
kubernetes-dashboard        NodePort    10.96.33.244   <none>        443:30000/TCP   19h   k8s-app=kubernetes-dashboard
```

#### 1.5 创建用户和角色绑定,查看Token

创建管理员账号

```bash
cat << EOF >dashboard-adminuser.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    k8s-app: kubernetes-dashboard
  name: dashboard-admin
  namespace: kubernetes-dashboard
EOF
kubectl create -f dashboard-adminuser.yaml
```

为用户分配权限

```bash
cat << EOF >dashboard-admin-bind-cluster-role.yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: dashboard-admin-bind-cluster-role
  labels:
    k8s-app: kubernetes-dashboard
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin
subjects:
- kind: ServiceAccount
  name: dashboard-admin
  namespace: kubernetes-dashboard
EOF
kubectl create -f dashboard-admin-bind-cluster-role.yaml
```

 查看并复制用户Token： 

```bash
kubectl get secret -n kubernetes-dashboard $(kubectl -n kubernetes-dashboard get secret| awk '/dashboard-admin/{print $1}') -o jsonpath={.data.token}|base64 -d
```

 访问：[https://10.0.0.31:30000](https://10.0.0.31:30000)或者https://dashbor.wzxmt.com，选择Token登录，输入刚才复制的密钥

#### 1.6 kubeconfig认证登录

由于每次登录。还地查看token，比较麻烦，因此可以采用kubeconfig文件认证

```bash
#APISERVER
KUBE_APISERVER=https://10.0.0.150:8443
#TOKEN
DASH_TOCKEN=$(kubectl get secret -n kubernetes-dashboard $(kubectl -n kubernetes-dashboard get secret| awk '/dashboard-admin/{print $1}') -o jsonpath={.data.token}|base64 -d)
```

生成kubeconfig文件]

```bash
kubectl config set-cluster kubernetes --server=${KUBE_APISERVER} --kubeconfig=/root/dashbord-admin.conf

kubectl config set-credentials dashboard-admin --token=$DASH_TOCKEN --kubeconfig=/root/dashbord-admin.conf

kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashbord-admin.conf

kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashbord-admin.conf
```

生成的dashbord-admin.conf即可用于登录dashboard