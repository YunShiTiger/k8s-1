traefik2.x和traefik1.x之间的总体差异比较大, 部署方式和ingress的配置方式都不一样, 现在基于官方文档来具体演示下如何在k8s(v1.14及以上)集群中配置traefik2.0.在traefik v2.0 版本后，开始使用CRD（Custom Resource Definition）来完成路由配置。

创建资源清单目录

```bash
mkdir -p traefik && cd traefik
```

准备CRD及RBAC权限

# 创建新命名空间 ingress-system
cat << 'EOF' >traefik-namespace.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-system
EOF
# 创建rbac 及Definitions 
cat << 'EOF' >traefik-rbac.yaml
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutes.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRoute
    plural: ingressroutes
    singular: ingressroute
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: middlewares.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: Middleware
    plural: middlewares
    singular: middleware
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutetcps.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRouteTCP
    plural: ingressroutetcps
    singular: ingressroutetcp
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressrouteudps.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRouteUDP
    plural: ingressrouteudps
    singular: ingressrouteudp
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tlsoptions.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TLSOption
    plural: tlsoptions
    singular: tlsoption
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tlsstores.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TLSStore
    plural: tlsstores
    singular: tlsstore
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: traefikservices.traefik.containo.us

spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TraefikService
    plural: traefikservices
    singular: traefikservice
  scope: Namespaced
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik

rules:
  - apiGroups:
      - ""
    resources:
      - services
      - endpoints
      - secrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses/status
    verbs:
      - update
  - apiGroups:
      - traefik.containo.us
    resources:
      - middlewares
      - ingressroutes
      - traefikservices
      - ingressroutetcps
      - ingressrouteudps
      - tlsoptions
      - tlsstores
    verbs:
      - get
      - list
      - watch

---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik

roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik
subjects:
  - kind: ServiceAccount
    name: traefik
    namespace: ingress-system
EOF
# 创建traefik daemonset yaml 私有环境daemonset 方式部署
cat << 'EOF' >traefik-daemonset-https.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik
  namespace: ingress-system
---
kind: DaemonSet
apiVersion: apps/v1
metadata:
  namespace: ingress-system
  name: traefik
  labels:
    k8s-app: traefik
spec:
  selector:
    matchLabels:
      k8s-app: traefik
  template:
    metadata:
      labels:
        k8s-app: traefik
      annotations:
        prometheus.io/port: "8082"
        prometheus.io/scrape: 'true'
    spec:
      serviceAccountName: traefik
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: traefik
          image: traefik:v2.2.1
          args:
            - --api.insecure
            - --api.dashboard
            - --log
            - --log.level=INFO
            - --accesslog
            - --accessLog.fields.headers.defaultMode=redact
            - --entrypoints.web.Address=:80
            - --entrypoints.websecure.Address=:443
            - --providers.kubernetescrd
            - --metrics.prometheus
            - --metrics.prometheus.entrypoint=metrics
            - --metrics.prometheus.addEntryPointsLabels=true
            - --entryPoints.metrics.address=:8082
            - --serverstransport.insecureskipverify=true
            - --providers.kubernetesingress.disablepasshostheaders=true
          ports:
            - name: web
              containerPort: 80
              hostPort: 80
            - name: websecure
              containerPort: 443
              hostPort: 443
            - name: admin
              containerPort: 8080
              hostPort: 8080
            - name: http-metrics
              containerPort: 8082
              hostPort: 8082
          securityContext:
            capabilities:
              drop:
              - ALL
              add:
              - NET_BIND_SERVICE
      #nodeSelector:
        #ingress: "yes"
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/ingress
        operator: Equal
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

---
apiVersion: v1
kind: Service
metadata:
  labels:
    k8s-app: traefik  
  name: traefik
  namespace: ingress-system
spec:
  clusterIP: None
  type: ClusterIP
  ports:
    - protocol: TCP
      name: web
      port: 80
    - protocol: TCP
      name: admin
      port: 8080
    - protocol: TCP
      name: websecure
      port: 443
    - protocol: TCP
      name: http-metrics
      port: 8082
  selector:
    k8s-app: traefik
EOF
# 创建 traefik dashboard  ingress
cat << 'EOF' >traefik-dashboard.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard
  namespace: ingress-system
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`traefik.tycng.com`)
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
EOF

测试ingress转发htpps

创建证书，以及 cert 存储方式

```bash
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout wzxmt.com.key -out wzxmt.com.crt -subj "/CN=wzxmt.com"
kubectl create secret tls tls-test --key wzxmt.com.key --cert wzxmt.com.crt
```

示例：

```yaml
cat << 'EOF' >traefik-https.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-dm
spec:
  replicas: 2
  selector:
    matchLabels:
      name: nginx
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
      - name: nginx
        image: wangyanglinux/myapp:v2
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:  
  name: test01
spec:  
  ports:    
    - port: 80      
      targetPort: 80      
      protocol: TCP  
  selector:    
    name: nginx
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: test.com-tls
spec:
  entryPoints:
    - websecure
  routes:
  - match: Host(`home.wzxmt.com`) && PathPrefix(`/`)
    kind: Rule
    services:
    - name: test01
      port: 80
  tls:
    secretName: tls-test
EOF
kubectl apply -f traefik-https.yaml
```

