Traefik 2.0 实现自动化HTTPS

使用 Let’s Encrypt 来进行自动化 HTTPS，就需要首先开启 ACME，开启ACME需要通过静态配置的方式,也就是说可以通过环境变量、启动参数等方式来提供，我们这里还是直接使用启动参数的形式来开启，在 Traefik 的部署文件中添加如下命令行参数：
```yaml
args:
# 使用 tls 验证这种方式
- --certificatesresolvers.default.acme.tlsChallenge=true
# 邮箱配置
- --certificatesResolvers.default.acme.email="ych_1024@163.com"
# 保存 ACME 证书的位置
- --certificatesResolvers.default.acme.storage="acme.json"
# 下面是用于测试的ca服务，如果https证书生成成功了，则移除下面参数
- --certificatesresolvers.default.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
```
这里我们使用的是tlsChallenge 这种 ACME 验证方式，需要注意的是当使用这种验证时，Let’s Encrypt 到 Traefik 443 端口必须是可达的，除了这种验证方式外，还有 httpChallenge 和 dnsChallenge 两种验证方式，更常用的是 http这种验证方式，关于这几种验证方式的使用可以查看文档：https://www.qikqiak.com/traefik-book/https/acme/ 了解他们之间的区别。

上面我们相当于指定了一个名为 default 的证书解析器，然后要注意的是，一定要将这里的 WebUI 的域名traefik.qikqiak.com 解析到 Traefik 的所在节点，解析完成后，重新部署 Traefik：

```bash
kubectl aplly -f ds.yaml
```


部署完成后，我们需要让 WebUI 的域名去监听 443 端口，因为我们这里使用的是 tlsChallenge 这种验证方式，在上面的 IngressRoute.yaml 文件中新建一个对象，用来监听 443 端口，如下所示：

```yaml
cat << 'EOF' > traefiks-encrypt.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefiks-encrypt
  namespace: ingress-system
spec:
  entryPoints:
    - websecure
  routes:
  - match: Host(`traefik.wzxmt.com`)
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
    tls:
    certResolver: default # 使用我们配置的 default 这个解析器
EOF
kubectl apply -f traefiks-encrypt.yaml
```
现在有两个 IngressRoute 对象

```bash
[root@supper traefik]# kubectl get IngressRoute -n ingress-system
NAME                AGE
traefik-dashboard   3s
traefiks-encrypt    3m23s
```


这个时候如果一切正常的话我们已经可以通过HTTPS去访问我们的服务了

Traefik 会自动跟踪其生成的 ACME 证书的到期日期。如果证书过期之前还不到30天了，Traefik 会尝试进行自动续订。同样的，我们通过 HTTP协议也是可以访问到的，但是如果需要将HTTP请求强制跳转到HTTPS的话，就需要借助Traefik 2.0的提供的中间件来完成了。