## 使用Helm部署metrics-server

从 Heapster 的 github <https://github.com/kubernetes/heapster >中可以看到已经，heapster 已经DEPRECATED。这里是heapster的deprecation timeline。可以看出 heapster 从 Kubernetes 1.12 开始将从 Kubernetes 各种安装脚本中移除。Kubernetes 推荐使用metrics-server。我们这里也使用helm来部署metrics-server。

metrics-server.yaml

```yaml
args:
- --logtostderr
- --kubelet-insecure-tls
- --kubelet-preferred-address-types=InternalIP
```

部署

```bash
helm install stable/metrics-server -n metrics-server --namespace kube-system -f \ 
metrics-server.yaml
```

使用下面的命令可以获取到关于集群节点基本的指标信息：

```
kubectl top node
NAME    CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%
node1   650m         32%    1276Mi          73%
node2   73m          3%     527Mi           30%
```

```bash
kubectl top pod --all-namespaces
NAMESPACE       NAME                                             CPU(cores)   MEMORY(bytes)
ingress-nginx   nginx-ingress-controller-6f5687c58d-jdxzk        3m           142Mi
ingress-nginx   nginx-ingress-controller-6f5687c58d-lxj5q        5m           146Mi
ingress-nginx   nginx-ingress-default-backend-6dc6c46dcc-lf882   1m           4Mi
kube-system     coredns-86c58d9df4-k5jkh                         2m           15Mi
kube-system     coredns-86c58d9df4-rw6tt                         3m           23Mi
kube-system     etcd-node1                                       20m          86Mi
kube-system     kube-apiserver-node1                             33m          468Mi
kube-system     kube-controller-manager-node1                    29m          89Mi
kube-system     kube-flannel-ds-amd64-8nr5j                      2m           13Mi
kube-system     kube-flannel-ds-amd64-bmncz                      2m           21Mi
kube-system     kube-proxy-d5gxv                                 2m           18Mi
kube-system     kube-proxy-zm29n                                 2m           16Mi
kube-system     kube-scheduler-node1                             8m           28Mi
kube-system     kubernetes-dashboard-788c98d699-qd2cx            2m           16Mi
kube-system     metrics-server-68785fbcb4-k4g9v                  3m           12Mi
kube-system     tiller-deploy-c4fd4cd68-dwkhv                    1m           24Mi
```

