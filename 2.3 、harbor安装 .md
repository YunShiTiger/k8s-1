## harbor安装

## 1.0 harbor单机部署

#### 1.1 安装 docker-compose 

我们将harbor装在jenkins上,在执行构建成功后,直接推送到harbor上,节省了流量.只需要

harbor依赖 docker-compose ，需要先 安装 [docker-compose]( https://github.com/docker/compose/releases )

下载 docker-compose 二进制包

```bash
wget https://github.com/docker/compose/releases/download/1.25.5/docker-compose-Linux-x86_64
mv docker-compose-Linux-x86_64 /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

#### 1.2 生成证书(ssl证书不能放在harbor目录下)

**cfssl下载**

```bash
wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64 -O /usr/local/bin/cfssl
wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64 -O /usr/local/bin/cfssljson
chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson
```

生成ca

```bash
mkdir -p /etc/ssl/
cd /etc/ssl/
cat >ca-config.json << EOF
{"signing":{"default":{"expiry":"87600h"},"profiles":{"kubernetes":{"usages":["signing","key encipherment","server auth","client auth"],"expiry":"87600h"}}}}
EOF
cat > ca-csr.json << EOF 
{"CN": "kubernetes","key": {"algo": "rsa","size": 2048},"names":[{"C": "CN","ST": "BeiJing","L": "BeiJing","O": "kubernetes","OU": "k8s"}]}
EOF
cfssl gencert -initca ca-csr.json | cfssljson -bare ca
```

生产harbor.wzxmt.com

```bash
cat > harbor.wzxmt.com-csr.json << EOF
{"CN":"harbor.wzxmt.com","key":{"algo": "rsa","size":2048},"names":[{"C":"CN","L":"BeiJing","ST":"BeiJing","O":"kubernetes","OU":"k8s"}]}
EOF
cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes harbor.wzxmt.com-csr.json | cfssljson -bare haabor.wzxmt.com
rm -f ca* *csr*
```

#### 1.3 下载harbor

域名解析

```bash
harbor.wzxmt.com  --- 10.0.0.20
```

[habor]( https://github.com/goharbor/harbor/releases/ )有两种安装方式,第一种是在线( harbour-online-installer-*),需要网络,另外一种是离线方式(harbour-offline-installer-\*)

```bash
https://github.com/goharbor/harbor/releases/download/v2.1.2/harbor-offline-installer-v2.1.2.tgz
```

离线安装程序：

```bash
tar xvf harbor-offline-installer-v2.1.2.tgz -C /usr/local/src/
ln -s /usr/local/src/harbor /usr/local/harbor
cd /usr/local/harbor
```

修改配置

```yaml
cp harbor.yml{,.bak}
cat << 'EOF' >harbor.yml
hostname: harbor.wzxmt.com
https:
  port: 443
  certificate: /etc/ssl/habor.wzxmt.com.pem
  private_key: /etc/ssl/habor.wzxmt.com-key.pem
harbor_admin_password: admin
database:
  password: admin
  max_idle_conns: 50
  max_open_conns: 100
data_volume: /data/harbor/data/
clair:
  updaters_interval: 12
jobservice:
  max_job_workers: 10
notification:
  webhook_job_max_retry: 10
chart:
  absolute_url: disabled
log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /data/harbor/logs
_version: 1.9.0
proxy:
  http_proxy:
  https_proxy:
  no_proxy: 127.0.0.1,localhost,.local,.internal,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair
  components:
    - core
    - jobservice
    - clair
EOF
```

主要修改了ip或者域名，用户，password，还有路径与日志,使用https访问.

#### 1.4 启动harbor

修改好配置之后,需要加载配置

```bash
./prepare --with-notary --with-clair --with-chartmuseum
```

安装

```bash
./install.sh
```

harbor的启动,停止,重启以及删除harbor(只能在harbor目录下操作)

```bash
docker-compose start
docker-compose stop
docker-compose restart
docker-compose down -v
```

成功后,我们可以通过[harbor.wzxmt.com](https://harbor.wzxmt.com)访问我们的镜像仓库

#### 1.5 本地登录镜像仓库报错:

```bash
docker login https://harbor.wzxmt.com
Username: admin
Password: 
Error response from daemon: Get https://harbor.wzxmt.com/v2/: x509: certificate is valid for habor.wzxmt.com, not harbor.wzxmt.com
```

需要配置docker信任仓库地址,在etc/docker/daemon.json添加这两行

```bash
"insecure-registries": ["https://harbor.wzxmt.com"]
```

然后重启docker

```bash
systemctl restart docker
```

这时候本地就能登陆镜像仓库了,这时候会在本地生成/root/.docker/config.json文件,可以将这个文件拷到其他计算机的相同位置下,即可免密拉取,推送镜像.

#### 1.6 推送镜像

```bash
#新建test私有仓库
#下载镜像
docker pull wangyanglinux/myapp:v1
#打标签
docker tag wangyanglinux/myapp:v1 harbor.wzxmt.com/test/myapp:v1
#推送镜像
docker push harbor.wzxmt.com/test/myapp:v1
```

## 2. harbor高可用集群部署

域名解析

```bash
harbor.wzxmt.com ---- 10.0.0.50
```

#### 2.1 分别在两台主机上安装docker-compose

#### 2.2两台下载,并解压

```bash
https://github.com/goharbor/harbor/releases/download/v2.1.2/harbor-offline-installer-v2.1.2.tgz
```

#### 2.3生成配置

修改barbor.yml文件,采用hostname设置访问地址，可以使用ip、域名，不可以设置为127.0.0.1、0.0.0.0或localhost

```yaml
cp harbor.yml{,.bak}
cat << 'EOF' >harbor.yml
hostname: 10.0.0.21
https:
  port: 443
  certificate: /etc/ssl/habor.wzxmt.com.pem
  private_key: /etc/ssl/habor.wzxmt.com-key.pem
harbor_admin_password: admin
database:
  password: admin
  max_idle_conns: 50
  max_open_conns: 100
data_volume: /data/harbor/data/
clair:
  updaters_interval: 12
jobservice:
  max_job_workers: 10
notification:
  webhook_job_max_retry: 10
chart:
  absolute_url: disabled
log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /data/harbor/logs
_version: 1.9.0
proxy:
  http_proxy:
  https_proxy:
  no_proxy: 127.0.0.1,localhost,.local,.internal,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair
  components:
    - core
    - jobservice
    - clair
EOF
```

启动habor

```bash
./prepare --with-notary --with-clair --with-chartmuseum
./install.sh
```

启动成功后,通过浏览器访问[harbor](https://10.0.0.36)成功,表示部署成功!

#### 2.4 两台master节点安装keepalived

```bash
yum install -y keepalived
systemctl enable keepalived.service 
```

#### 2.5 keepalived配置及启动

keepalived配置文件，其余节点修改state为BACKUP，priority小于主节点即可；

```bash
cat<< EOF >/etc/keepalived/keepalived.conf
! Configuration File for keepalived
vrrp_script check_harbor {
        script "/etc/keepalived/check_harbor.sh"
        interval 4
        weight 60  
}
vrrp_instance VI_1 {
    state MASTER  
    interface eth0
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    track_script {
        check_harbor
    }
    virtual_ipaddress {
        10.0.0.50
    }
}
EOF
```

编写监控脚本

```bash
cat<< 'EOF' >/etc/keepalived/check_harbor.sh
#!/bin/bash
flag=`ss -lntup|awk '{print $5}'|awk -F'[:]' '{print $NF}'|grep -w 443`
if [ -z $flag ];then
    echo "harbor is down,close the keepalived"
    systemctl stop keepalived
fi
EOF
chmod +x /etc/keepalived/check_harbor.sh
```

启动keepalived

```bash
systemctl restart keepalived.service 
```

分别在两台上加入镜像仓库

```bash
"insecure-registries": ["https://harbor.wzxmt.com","https://10.0.0.20","https://10.0.0.21"]
```

重启docker与harbor,此时可以在客户端登录仓库

```bash
docker login https://harbor.wzxmt.com
```

#### 2.6 浏览器登录镜像仓库，开始配置Harbor的复制仓库功能

```bash
https://harbor.wzxmt.com
```

在主[Harbor](10.0.0.36),创建新项目test

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023555%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt="新建项目" style="zoom:100%;" />

在主Harbor的仓库管理->新建目标：

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023532%E6%96%B0%E5%BB%BA%E7%9B%AE%E6%A0%87.png" alt="新建目标" style="zoom:100%;" />

在Harbor的复制管理->新建规则：

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023517%E6%96%B0%E5%BB%BA%E8%A7%84%E5%88%99.png" alt="新建规则" style="zoom:100%;" />

在备[harbor](10.0.0.37)也按照主配置,就实现主主复制,经测试推送镜像能够双向复制.