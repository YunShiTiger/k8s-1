## harbor安装

## 1.0 harbor单机部署

#### 1.1 安装 docker-compose 

我们将harbor装在jenkins上,在执行构建成功后,直接推送到harbor上,节省了流量.只需要

harbor依赖 docker-compose ，需要先 安装 [docker-compose]( https://github.com/docker/compose/releases )

下载 docker-compose 二进制包

```bash
wget https://github.com/docker/compose/releases/download/1.25.0-rc4/docker-compose-Linux-x86_64
mv docker-compose-Linux-x86_64 /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose
```

#### 1.2 生成证书

创建证书

```bash
#创建证书目录
mkdir -p /data/ssl
cd /data/ssl/
#创建CA根证书
openssl req  -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj "/C=CN/ST=Guandong/L=Shenzheng/O=example/OU=Personal/CN=wzxmt.com.cn"
#生成一个证书签名, 设置访问域名为wzxmt.com.cn
openssl req -newkey rsa:4096 -nodes -sha256 -keyout wzxmt.com.cn.key -out server.csr -subj "/C=CN/ST=Guandong/L=Shenzheng/O=example/OU=Personal/CN=wzxmt.com.cn"
#生成主机的证书
openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out wzxmt.com.cn.crt
```

#### 1.3 下载harbor

域名解析

```bash
harbor.wzxmt.com.cn  --- 10.0.0.36
```

[habor]( https://github.com/goharbor/harbor/releases/ )有两种安装方式,第一种是在线( harbour-online-installer-*),需要网络,另外一种是离线方式(harbour-offline-installer-\*)

```bash
https://github.com/goharbor/harbor/releases/download/v1.9.2/harbor-offline-installer-v1.9.2.tgz
```

离线安装程序：

```bash
tar xvf harbor-offline-installer-v1.9.2.tgz -C /usr/local/src/
ln -s /usr/local/src/harbor /usr/local/harbor
cd /usr/local/harbor
```

修改配置

```bash
cp harbor.yml{,.bak}
cat << 'EOF' >harbor.yml
hostname: harbor.wzxmt.com.cn
https:
  port: 443
  certificate: /data/cert/wzxmt.com.cn.crt
  private_key: /data/cert/wzxmt.com.cn.key
harbor_admin_password: admin
database:
  password: admin
  max_idle_conns: 50
  max_open_conns: 100
data_volume: /data/harbor/data/
clair:
  updaters_interval: 12
jobservice:
  max_job_workers: 10
notification:
  webhook_job_max_retry: 10
chart:
  absolute_url: disabled
log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /data/harbor/logs
_version: 1.9.0
proxy:
  http_proxy:
  https_proxy:
  no_proxy: 127.0.0.1,localhost,.local,.internal,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair
  components:
    - core
    - jobservice
    - clair
EOF
```

主要修改了ip或者域名，用户，password，还有路径与日志,使用https访问.

#### 1.4 启动harbor

修改好配置之后,需要加载配置

```
./prepare
```

安装

```
./install.sh
```

harbor的启动,停止,重启以及删除harbor(只能在harbor目录下操作)

```bash
docker-compose start
docker-compose stop
docker-compose restart
docker-compose down -v
```

成功后,我们可以通过[harbor.wzxmt.com.cn](https://harbor.wzxmt.com.cn)访问我们的镜像仓库

#### 1.5 本地登录镜像仓库报错:

```bash
[root@jenkins data]# docker login harbor.wzxmt.com.cn
Username: admin
Password:
Error response from daemon: Get https://harbor.wzxmt.com.cn/v2/: x509: certificate is not valid for any names, but wanted to match harbor.wzxmt.com.cn
```

需要配置docker信任仓库地址,在etc/docker/daemon.json添加这两行

```bash
"insecure-registries": ["http://harbor.wzxmt.com.cn"],"insecure-registries": ["https://harbor.wzxmt.com.cn"]
```

然后重启docker

```bash
systemctl restart docker
```

这时候本地就能登陆镜像仓库了,这时候会在本地生成/root/.docker/config.json文件,可以将这个文件拷到其他计算机的相同位置下,即可免密拉取,推送镜像.

## 2. harbor高可用集群部署

域名解析

```bash
harbor.wzxmt.com.cn ---- 10.0.0.50
```

#### 2.1 分别在两台主机上安装docker-compose

#### 2.2两台下载,并解压

```bash
harborhttps://github.com/goharbor/harbor/releases/download/v1.9.2/harbor-offline-installer-v1.9.2.tgz
```

#### 2.3生成证书

```bash
#创建证书目录
mkdir -p /data/ssl
cd /data/ssl/
#创建CA根证书
openssl req  -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj "/C=CN/ST=Guandong/L=Shenzheng/O=example/OU=Personal/CN=wzxmt.com.cn"
#生成一个证书签名, 设置访问域名为wzxmt.com.cn
openssl req -newkey rsa:4096 -nodes -sha256 -keyout wzxmt.com.cn.key -out server.csr -subj "/C=CN/ST=Guandong/L=Shenzheng/O=example/OU=Personal/CN=wzxmt.com.cn"
#生成主机的证书
openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out wzxmt.com.cn.crt
```

(3)修改barbor.yml文件,采用hostname设置访问地址，可以使用ip、域名，不可以设置为127.0.0.1、0.0.0.0或localhost

```bash
cp harbor.yml{,.bak}
cat << 'EOF' >harbor.yml
hostname: 10.0.0.36
https:
  port: 443
  certificate: /data/ssl/wzxmt.com.cn.crt
  private_key: /data/ssl/wzxmt.com.cn.key
harbor_admin_password: admin
database:
  password: admin
  max_idle_conns: 50
  max_open_conns: 100
data_volume: /data/harbor/data/
clair:
  updaters_interval: 12
jobservice:
  max_job_workers: 10
notification:
  webhook_job_max_retry: 10
chart:
  absolute_url: disabled
log:
  level: info
  local:
    rotate_count: 50
    rotate_size: 200M
    location: /data/harbor/logs
_version: 1.9.0
proxy:
  http_proxy:
  https_proxy:
  no_proxy: 127.0.0.1,localhost,.local,.internal,log,db,redis,nginx,core,portal,postgresql,jobservice,registry,registryctl,clair
  components:
    - core
    - jobservice
    - clair
EOF
```

启动habor

```bash
./prepare
./install.sh
```

启动成功后,通过浏览器访问[harbor](https://10.0.0.36)成功,表示部署成功!

#### 2.4 两台master节点安装keepalived

```bash
yum install -y keepalived
systemctl enable keepalived.service 
```

#### 2.5 keepalived配置及启动

keepalived配置文件，其余节点修改state为BACKUP，priority小于主节点即可；

```bash
cat<< EOF >/etc/keepalived/keepalived.conf
! Configuration File for keepalived
vrrp_script check_harbor {
        script "/etc/keepalived/check_harbor.sh"
        interval 4
        weight 60  
}
vrrp_instance VI_1 {
    state MASTER  
    interface eth0
    virtual_router_id 51
    priority 150
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    track_script {
        check_harbor
    }
    virtual_ipaddress {
        10.0.0.50
    }
}
EOF
```

编写监控脚本

```bash
cat<< 'EOF' >/etc/keepalived/check_harbor.sh
#!/bin/bash
flag=`ss -lntup|awk '{print $5}'|awk -F'[:]' '{print $NF}'|grep -w 443`
if [ -z $flag ];then
    echo "harbor is down,close the keepalived"
    systemctl stop keepalived
fi
EOF
chmod +x /etc/keepalived/check_harbor.sh
```

启动keepalived

```bash
systemctl restart keepalived.service 
```

分别在两台上加入镜像仓库

```bash
"insecure-registries": ["https://harbor.wzxmt.com.cn","https://10.0.0.36","https://10.0.0.37"]
```

重启docker与harbor,此时可以在客户端登录仓库

```bash
docker login https://harbor.wzxmt.com.cn
```

#### 2.6 浏览器登录镜像仓库，开始配置Harbor的复制仓库功能

```bash
https://harbor.wzxmt.com.cn
```

在主[Harbor](10.0.0.36),创建新项目test

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023555%E6%96%B0%E5%BB%BA%E9%A1%B9%E7%9B%AE.png" alt="新建项目" style="zoom:100%;" />

在主Harbor的仓库管理->新建目标：

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023532%E6%96%B0%E5%BB%BA%E7%9B%AE%E6%A0%87.png" alt="新建目标" style="zoom:100%;" />

在Harbor的复制管理->新建规则：

<img src="https://images.cnblogs.com/cnblogs_com/wzxmt/1506688/o_200324023517%E6%96%B0%E5%BB%BA%E8%A7%84%E5%88%99.png" alt="新建规则" style="zoom:100%;" />

在备[harbor](10.0.0.37)也按照主配置,就实现主主复制,经测试推送镜像能够双向复制.