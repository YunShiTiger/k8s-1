安装nginx与keepalived

```bash
rpm -ivh http://nginx.org/packages/centos/7/noarch/RPMS/nginx-release-centos-7-0.el7.ngx.noarch.rpm 
yum install -y nginx keepalived
rm -f /etc/nginx/conf.d/default.conf
```

注意:keepalived配置文件，其余节点修改state为BACKUP，priority小于主节点即可；检查网卡名称并修改

```bash
cat<< EOF >/etc/keepalived/keepalived.conf
vrrp_script chk_nginx {
        script "/etc/keepalived/check_nginx.sh"
        interval 4
        weight 60  
}
vrrp_instance VI_1 {
    state MASTER
    #state BACKUP
    interface eth0
    virtual_router_id 51
    priority 150
    #priority 140
    advert_int 1
    authentication {
        auth_type PASS
        auth_pass 1111
    }
    track_script {
        chk_nginx
    }
    virtual_ipaddress {
        10.0.0.50
    }
}
EOF
cat << 'EOF' >/etc/keepalived/check_nginx.sh
#!/bin/bash
flag=$(ps -ef|grep -v grep|grep -w 'nginx' &>/dev/null;echo $?)
if [[ $flag != 0 ]];then
        echo "nginx is down,close the keepalived"
        systemctl stop keepalived
fi
EOF
```

修改nginx转发,并将证书放到相应位置

```bash
cat << 'EOF' >/etc/nginx/conf.d/wzxmt.conf  
#http转发
upstream default_backend_traefik {
    server 10.0.0.41 max_fails=3 fail_timeout=10s;
    server 10.0.0.42 max_fails=3 fail_timeout=10s;
}
server {
    server_name *.wzxmt.com;
    access_log /var/log/nginx/http-access.log;
    error_log  /var/log/nginx/http-error.log;
    location / {
        proxy_pass http://default_backend_traefik;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    }
}
#https转发
upstream default_backend_traefiks {
    server 10.0.0.41:443 max_fails=3 fail_timeout=10s weight=5;
    server 10.0.0.42:443 max_fails=3 fail_timeout=10s weight=5;
}
server {
    listen       443 ssl;
    server_name  *.wzxmt.com;

    ssl_certificate "ssl/wzxmt.com.crt";
    ssl_certificate_key "ssl/wzxmt.com.key";
    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    access_log /var/log/nginx/https-access.log;
    error_log  /var/log/nginx/https-error.log;

    location / {
        proxy_pass https://default_backend_traefiks;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    }
}
EOF
```

请注意，stream配置不能放到http内，即不能放到/etc/nginx/conf.d/，因为stream是通过tcp层转发，而不是http转发

```bash
cat << 'EOF'>>/etc/nginx/nginx.conf
stream {
    log_format proxy '$remote_addr [$time_local]'
                     '$protocol $status $bytes_sent $bytes_received'
                     '$session_time "$upstream_addr" '
                     '"$upstream_bytes_sent" "$upstream_bytes_received" "$upstream_connect_time"';
    access_log /var/log/nginx/tcp-access.log proxy;
    error_log  /var/log/nginx/tcp-error.log;
    open_log_file_cache off;
    # 添加socket转发的代理
    upstream socket_proxy {
        hash $remote_addr consistent;
        server 10.0.0.41:6379 weight=5 max_fails=3 fail_timeout=10s;
        server 10.0.0.42:6379 weight=5 max_fails=3 fail_timeout=10s;
    }
    server {
       listen 6379;
       proxy_connect_timeout 1s;
       proxy_timeout 3s;
       proxy_pass socket_proxy;
    }
}
EOF
```

启动服务

```bash
systemctl enable --now nginx.service
systemctl enable --now keepalived.service
```

通过泛域名解析，无差异的将流量抛给Ingress，不需要再动nginx，添加新项目时，只需要在需要Ingress定义即可