## 1.简介

traefik 与 nginx一样，是一款优秀的反向代理工具，或者叫 `Edge Router`。至于使用它的原因则基于以下几点

- 无须重启即可更新配置
- 自动的服务发现与负载均衡
- 与 `docker` 的完美集成，基于 `container label` 的配置
- 漂亮的 `dashboard` 界面
- `metrics` 的支持，对 `prometheus` 和 `k8s` 的集成

traefik2.x和traefik1.x之间的总体差异比较大, 部署方式和ingress的配置方式都不一样, 现在基于官方文档来具体演示下如何在k8s(v1.14及以上)集群中配置traefik2.0

在traefik v2.0 版本后，开始使用CRD（Custom Resource Definition）来完成路由配置。

## 2.交付traefik

#### 创建资源清单目录

```bash
mkdir -p traefik && cd traefik
```

#### namespace

```bash
cat<< 'EOF' > 00-init.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-system
EOF
```

#### crd

```yaml
cat<< 'EOF' > traefik-crd.yaml
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutes.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRoute
    plural: ingressroutes
    singular: ingressroute
  scope: Namespaced
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: middlewares.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: Middleware
    plural: middlewares
    singular: middleware
  scope: Namespaced
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressroutetcps.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRouteTCP
    plural: ingressroutetcps
    singular: ingressroutetcp
  scope: Namespaced
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: ingressrouteudps.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: IngressRouteUDP
    plural: ingressrouteudps
    singular: ingressrouteudp
  scope: Namespaced
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tlsoptions.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TLSOption
    plural: tlsoptions
    singular: tlsoption
  scope: Namespaced

---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: tlsstores.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TLSStore
    plural: tlsstores
    singular: tlsstore
  scope: Namespaced
---
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: traefikservices.traefik.containo.us
spec:
  group: traefik.containo.us
  version: v1alpha1
  names:
    kind: TraefikService
    plural: traefikservices
    singular: traefikservice
  scope: Namespaced
EOF
```

#### rbac 

```yaml
cat<< 'EOF' > traefik-rbac.yaml
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: traefik
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
rules:
  - apiGroups:
      - ""
    resources:
      - services
      - endpoints
      - secrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
      - networking.k8s.io
    resources:
      - ingresses
      - ingressclasses
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
      - networking.k8s.io
    resources:
      - ingresses/status
    verbs:
      - update
  - apiGroups:
      - traefik.containo.us
    resources:
      - ingressroutes
      - ingressroutetcps
      - ingressrouteudps
      - middlewares
      - tlsoptions
      - tlsstores
      - traefikservices
      - serverstransports
    verbs:
      - get
      - list
      - watch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: traefik
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik
subjects:
  - kind: ServiceAccount
    name: traefik
    namespace: ingress-system
EOF
```
#### 创建traefik-daemonset

```yaml
cat << EOF >traefik-daemonset.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik
  namespace: ingress-system
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
---
kind: DaemonSet
apiVersion: apps/v1
metadata:
  namespace: ingress-system
  name: traefik
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: traefik
      app.kubernetes.io/instance: traefik
  template:
    metadata:
      labels:
        app.kubernetes.io/name: traefik
        app.kubernetes.io/instance: traefik
    spec:
      volumes:
      - name: date
        hostPath: 
          path: /etc/localtime
          type: ''
      serviceAccountName: traefik
      terminationGracePeriodSeconds: 60
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: traefik
          image: traefik:v2.2.10
          readinessProbe:
            httpGet:
              path: /ping
              port: 9000
            failureThreshold: 1
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          livenessProbe:
            httpGet:
              path: /ping
              port: 9000
            failureThreshold: 3
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 2
          args:
            - --api.insecure=true
            - --api=true
            - --api.dashboard
            - --accesslog
            - --accesslog.filepath=/var/log/traefik-access.log
            - --accessLog.fields.headers.defaultMode=redact
            - --global.checknewversion
            - --global.sendanonymoususage
            - --log
            - --ping
            - --log.level=INFO
            - --entrypoints.web.Address=:80
            - --entrypoints.websecure.Address=:443
            - --entrypoints.redis.Address=:6379
            - --entryPoints.metrics.address=:8090
            - --entryPoints.traefik.address=:9000
            - --serverstransport.insecureskipverify=true
            - --providers.kubernetescrd
            - --providers.kubernetesingress
            - --metrics.prometheus=true
            - --metrics.prometheus.buckets=0.100000, 0.300000, 1.200000, 5.000000
            - --metrics.prometheus.addEntryPointsLabels=true
            - --metrics.prometheus.addServicesLabels=true
            - --metrics.prometheus.entryPoint=metrics
          ports:
            - name: web
              containerPort: 80
              hostPort: 80
            - name: websecure
              containerPort: 443
              hostPort: 443
            - name: redis
              containerPort: 6379
              hostPort: 6379
            - name: admin
              containerPort: 8090
              hostPort: 8090
            - name: traefik
              containerPort: 9000
              hostPort: 9000
          volumeMounts:
          - name: date
            mountPath: /etc/localtime
          securityContext:
            capabilities:
              drop:
              - ALL
              add:
              - NET_BIND_SERVICE
      tolerations:
      - effect: NoSchedule
        key: node-role.kubernetes.io/ingress
        operator: Equal
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
EOF
```
#### 创建traefik-svc

```yaml
cat << 'EOF' > traefik-svc.yaml
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
  name: traefik
  namespace: ingress-system
spec:
  clusterIP: None
  type: ClusterIP
  ports:
    - protocol: TCP
      name: web
      port: 80
    - protocol: TCP
      name: admin
      port: 8090
    - protocol: TCP
      name: websecure
      port: 443
  selector:
    app.kubernetes.io/name: traefik
EOF
```

#### 创建 traefik-dashboard

```yaml
cat << 'EOF' > traefik-dashboard.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: traefik-dashboard
  namespace: ingress-system
  labels:
    app.kubernetes.io/name: traefik
    app.kubernetes.io/instance: traefik
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`traefik.wzxmt.com`)
    kind: Rule
    services:
    - name: api@internal
      kind: TraefikService
EOF
```

#### 部署

```
kubectl apply -f ./
```

查看状态

```
[root@m1 ~]# kubectl get pod -n ingress-system
NAME            READY   STATUS    RESTARTS   AGE
traefik-9mr45   1/1     Running   0          8h
traefik-xzwx8   1/1     Running   0          8h
```

解析域名

```
traefik	60 IN A 10.0.0.50
```

这时候可以通过浏览器访问到traefik-dashboard

```
http://traefik.wzxmt.com
```

## 3.0 部署服务

#### 3.1 部署kubernetes-dashboard

```yaml
cat << 'EOF' >kubernetes-dashboard.yaml
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: kubernetes-dashboard-t
  namespace: kubernetes-dashboard
spec:
  entryPoints:
    - websecure
  routes:
  - match: Host(`dashbor.wzxmt.com`) && PathPrefix(`/`)
    kind: Rule
    services:
    - name: kubernetes-dashboard
      port: 443
  tls:
    secretName: kubernetes-dashboard-certs
EOF
kubectl apply -f kubernetes-dashboard.yaml
```

访问https://dashbor.wzxmt.com，能够访问

#### 3.2 创建自签证书

```bash
openssl req -x509 -sha256 -nodes -days 365 -newkey rsa:2048 -keyout wzxmt.com.key -out wzxmt.com.crt -subj "/CN=wzxmt.com"
```

#### 3.3  IngressRoute 方式为服务添加路由

创建secret

```bash
kubectl create secret tls traefik-damxs --key wzxmt.com.key --cert wzxmt.com.crt
```

示例1：

```yaml
cat << 'EOF' >traefik-https.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-https
spec:
  replicas: 2
  selector:
    matchLabels:
      name: nginx
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
      - name: nginx
        image: wangyanglinux/myapp:v2
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:  
  name: nginx-https
spec:  
  ports:    
    - port: 80      
      targetPort: 80      
      protocol: TCP  
  selector:    
    name: nginx
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: nginx-https
spec:
  entryPoints:
    - websecure
  routes:
  - match: Host(`home.wzxmt.com`) && PathPrefix(`/`)
    kind: Rule
    services:
    - name: nginx-https
      port: 80
  tls:
    secretName:   traefik-damxs
EOF
kubectl apply -f traefik-https.yaml
```

示例2：

```yaml
cat << 'EOF' >traefik-http.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-http
spec:
  replicas: 2
  selector:
    matchLabels:
      name: nginx
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
      - name: nginx
        image: wangyanglinux/myapp:v2
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:  
  name: test-http
spec:  
  ports:    
    - port: 80      
      targetPort: 80      
      protocol: TCP  
  selector:    
    name: nginx
---
apiVersion: traefik.containo.us/v1alpha1
kind: IngressRoute
metadata:
  name: test-http
spec:
  entryPoints:
    - web
  routes:
  - match: Host(`http.wzxmt.com`) && PathPrefix(`/`)
    kind: Rule
    services:
    - name: test-http
      port: 80
EOF
kubectl apply -f traefik-http.yaml
```

注意，采用https访问服务有两种方式,如果Service端口是443，traefik会去检测后端容器是否是https服务，因此后端是http服务，service不能使用443端口

- traefik（https）------ Service(http)
- traefik（https）------ Service(https)

#### 3.4 ingress方式为服务添加路由

[Kubernetes入口控制器](https://docs.traefik.io/v2.2/routing/providers/kubernetes-ingress/)策略

示例1：

```yaml
cat << EOF >ingress-traefik-http.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-dm
spec:
  replicas: 2
  selector:
    matchLabels:
      name: nginx
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
      - name: nginx
        image: wangyanglinux/myapp:v1
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:  
  name: nginx-dm
spec:  
  ports:    
    - port: 80      
      targetPort: 80      
      protocol: TCP  
  selector:    
    name: nginx
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:  
  name: nginx-test
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: web
spec:  
  rules:    
    - host: www.test.com      
      http:        
        paths:        
        - path: /          
          backend:            
            serviceName: nginx-dm            
            servicePort: 80
EOF
kubectl apply -f ingress-traefik-http.yaml
```

示例2：

创建secret

```bash
kubectl create secret tls tls-test-dxm  --key wzxmt.com.key --cert wzxmt.com.crt
```

```yaml
cat << EOF >ingress-traefik-https.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-dxm
spec:
  replicas: 2
  selector:
    matchLabels:
      name: nginx
  template:
    metadata:
      labels:
        name: nginx
    spec:
      containers:
      - name: nginx
        image: wangyanglinux/myapp:v3
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:  
  name: nginx-dxm
spec:  
  ports:    
    - port: 80      
      targetPort: 80      
      protocol: TCP  
  selector:    
    name: nginx
---
apiVersion: extensions/v1beta1
kind: Ingress
metadata:  
  name: nginx-test
  annotations:
    traefik.ingress.kubernetes.io/router.entrypoints: websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.tls.certresolver: tls-test-dxm
spec:  
  rules:    
    - host: dxm.wzxmt.com      
      http:        
        paths:        
        - path: /          
          backend:            
            serviceName: nginx-dxm            
            servicePort: 80
EOF
kubectl apply -f ingress-traefik-https.yaml
```

