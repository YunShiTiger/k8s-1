## 什么是 [Helm](https://github.com/helm/helm)

Helm是Kubernetes的包管理器，类似于 YUM 的包管理器，是部署环境的流程封装,主要用来管理 Charts。Helm Chart是用来封装Kubernetes原生应用程序的一系列YAML文件。可以在你部署应用的时候自定义应用程序的一些Metadata，以便于应用程序的分发。对于应用发布者而言，可以通过Helm打包应用、管理应用依赖关系、管理应用版本并发布应用到软件仓库。对于使用者而言，使用Helm后不用需要编写复杂的应用部署文件，可以以简单的方式在Kubernetes上查找、安装、升级、回滚、卸载应用程序。Helm和Kubernetes之间的关系可以如下类比。

![image-20200423112449281](https://raw.githubusercontent.com/wzxmt/images/master/img/image-20200423112449281.png)

## Helm 部署

越来越多的公司和团队开始使用 Helm 这个 Kubernetes 的包管理器，我们也将使用 Helm 安装 Kubernetes 的常用组件。github：https://github.com/helm/helm/releases ，Helm v3.0后，不再需要安装TillerHelm，Helm会 默认读取~/.kube/config 进行k8s 连接。安装方式有两种

1. 自动安装脚本

   ```bash
   wget https://raw.githubusercontent.com/helm/helm/master/scripts/get > get_helm.sh
   chmod +x get_helm.sh
   ./get_helm.sh
   ```

2. 二进制安装

```bash
ntpdate ntp1.aliyun.com
wget https://get.helm.sh/helm-v3.2.0-linux-amd64.tar.gz
tar -zxvf helm-v3.2.0-linux-amd64.tar.gz
cd linux-amd64/
cp helm /usr/local/bin/
```

## 增加常用chart源

helm提供了常用的chart源，可以在helm的hub库https://hub.helm.sh/charts查看提供的各种应用的chart库，左边是各种官方chart库，右边是chart库中的应用chart。

```bash
#应该都不需要科学，stable是官方的，aliyuncs最快
helm repo add stable https://kubernetes-charts.storage.googleapis.com
helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com	
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add aliyuncs https://apphub.aliyuncs.com
```

## 常用命令

```
helm repo add repo_name1 https://aliacs-app-catalog.oss-cn-hangzhou.aliyuncs.com/charts-incubator/
更新源
helm repo update
查看源
helm repo list
搜索远程源
helm search
创建项目 
#--name-template 或者可以不用写
helm install --name-template redis stable/redis-ha
更新
helm upgrade redis
卸载
helm uninstall redis
查询
helm list
```

helm详细[使用文档](https://helm.sh/docs/intro/using_helm/) 见官网。

## Helm 自定义模板

创建文件夹

```bash
mkdir ./hello-world
cd ./hello-world
```

创建自描述文件 Chart.yaml , 这个文件必须有 name 和 version 定义

```bash
cat <<'EOF' > ./Chart.yaml
name: hello-world
version: 1.0.0
EOF
```

创建模板文件，用于生成 Kubernetes 资源清单（manifests）

```bash
mkdir ./templates
```

生成 Kubernetes 资源清单

```yaml
cat <<'EOF' > ./templates/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:  
  name: hello-world
spec:  
  replicas: 1
  selector:    
    matchLabels:      
      app: hello-world 
  template:    
    metadata:      
      labels:        
        app: hello-world    
    spec:      
      containers:        
      - name: hello-world          
        image: hub.atguigu.com/library/myapp:v1          
        ports:            
          - containerPort: 80              
            protocol: TCP
EOF
```

```yaml
cat <<'EOF' > ./templates/service.yaml
apiVersion: v1
kind: Service
metadata:  
  name: hello-world
spec:  
  type: NodePort  
  ports:
  - port: 80    
    targetPort: 80    
    protocol: TCP  
  selector:    
    app: hello-world
EOF
```



```bash
使用命令 helm install RELATIVE_PATH_TO_CHART 创建一次Release
helm install .
# 列出已经部署的 Release
helm ls
# 查询一个特定的 Release 的状态
helm status RELEASE_NAME
# 移除所有与这个 Release 相关的 Kubernetes 资源
helm delete cautious-shrimp
# helm rollback RELEASE_NAME REVISION_NUMBER
helm rollback cautious-shrimp 1
# 使用 helm delete --purge RELEASE_NAME 移除所有与指定 Release 相关的 Kubernetes 资源和所有这个Release 的记录
helm delete --purge cautious-shrimp
helm ls --deleted
```

配置体现在配置文件 values.yaml

```yaml
cat <<'EOF' > ./values.yaml
image:  
  repository: gcr.io/google-samples/node-hello  
  tag: '1.0'
EOF
```

这个文件中定义的值，在模板文件中可以通过 .VAlues对象访问到

```yaml
cat <<'EOF' > ./templates/deployment.yaml
apiVersion: extensions/v1beta1
kind: Deployment
  metadata:  
  name: hello-worldspec: 
  replicas: 1  
  template:    
    metadata:      
    labels:        
      app: hello-world    
    spec:      
      containers:        
      - name: hello-world          
        image: {{ .Values.image.repository }}:{{ .Values.image.tag }}          
        ports:            
          - containerPort: 8080              
            protocol: TCP
EOF
```

\# 在 values.yaml 中的值可以被部署 release 时用到的参数 --values YAML_FILE_PATH 或 --setkey1=value1, key2=value2 覆盖掉

```bash
 helm install --set image.tag='latest' .
```

升级版本

```bash
helm upgrade  -f values.yaml test .
```

## Debug

\# 使用模板动态生成K8s资源清单，非常需要能提前预览生成的结果。# 使用--dry-run --debug 选项来打印出生成的清单文件内容，而不执行部署

```bash
helm install . --dry-run --debug --set image.tag=latest
```