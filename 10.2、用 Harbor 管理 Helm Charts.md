#### 简介

本文讲述的是调教 Helm 3 和 harbor 1.6+ 的经验，从 helm2 更新到 helm 3 并且将 charts 推送到 harbor 中进行存储，移除了原先的 helm serve,在讲述怎么操作之前先来看一下Helm 3 和 Harbor 2.0+ 的新特性。

#### Helm 3 新特性

- 移除了 Tiller
- 不同的 namespace 可以使用相同的 Release Name
- 简化模板对象 `.Capabilities`
- 使用`JSONSchema`验证 charts 的 Values
- 将`requirements.yaml`合并到`Chart.yaml`中
- helm install 时需要指定 Release Name，开启自动生成需要 `--generate-name` 参数
- 支持 push 到远端 registry （如：harbor）
- 移除 helm serve
- 命令行变化（将原先的命令保留为别名Aliases）
  - `helm delete` --> `helm uninstall`
  - `helm inspect` -> `helm show`
  - `helm fetch` -> `helm pull`
- go 导入路径改变 `k8s.io/helm` --> `helm.sh/helm`

##### 环境

- kubernetes 1.18.14
- helm 3
- harbor 2.0

#### 1.部署kubernetes环境（略）

#### 2.下载并初始化 helm 3

首先，需要安装 helm 客户端工具，具体安装 helm cli 可以参考：[Install Helm](https://helm.sh/docs/intro/)，安装完成后可以通过如下命令验证安装是否完成：

```shell
wget https://get.helm.sh/helm-v3.2.1-linux-amd64.tar.gz
tar zxvf helm-v3.2.1-linux-amd64.tar.gz
cp linux-amd64/helm /usr/local/bin
```

查看 helm 命令是否可用

```bash
helm version
version.BuildInfo{Version:"v3.2.1", GitCommit:"fe51cd1e31e6a202cba7dead9552a6d418ded79a", GitTreeState:"clean", GoVersion:"go1.13.10"}
```

解压之后，你如果使用过helm 2 你会发现里面tiller的二进制文件不见了，前文的新特性中已经说了，helm 3 已经移除了 tiller

#### 3.安装 harbor 2.0(略)

##### 3.1 启用 harbor 的 chart repository 服务

默认新版 harbor 不会启用 `chart repository service`，如果需要管理 `helm`，我们需要在安装时添加额外的参数，例如：

```bash
## 默认安装
./install.sh
## 启动 chart repository service 服务
./install.sh --with-chartmuseum
```

等待安装完成即可，安装完成后会有如下类似提示：

```bash
...
✔ ----Harbor has been installed and started successfully.----
...
```

#### 4.添加 harbor helm 仓库

添加基础仓库

```
helm repo add stable https://kubernetes-charts.storage.googleapis.com
helm repo add incubator https://kubernetes-charts-incubator.storage.googleapis.com	
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo add aliyuncs https://apphub.aliyuncs.com
```

在使用之前，应该使用 `helm repo add` 命令将 `Harbor` 添加到存储库列表中。它支持两种不同的模式：

```bash
#添加 harbor  helm-charts 仓库地址
helm repo add --ca-file=ca.crt --cert-file=harbor.wzxmt.com.crt --key-file=harbor.wzxmt.com.key --username=admin --password=admin myrepo https://harbor.wzxmt.com/chartrepo
#具体的项目地址
helm repo add --ca-file=ca.crt --cert-file=harbor.wzxmt.com.crt --key-file=harbor.wzxmt.com.key --username=admin --password=admin library https://harbor.wzxmt.com/chartrepo/library
#更新
helm repo update
#安装helm-push 插件
helm plugin install https://github.com/chartmuseum/helm-push
#或者
wget https://github.com/chartmuseum/helm-push/releases/download/v0.9.0/helm-push_0.9.0_linux_amd64.tar.gz
mkdir /root/.local/share/helm/plugins/helm-push -p
tar xf helm-push_0.9.0_linux_amd64.tar.gz -C /root/.local/share/helm/plugins/helm-push
```

测试

```bash
#查找项目
helm search repo mysql
helm search hub mysql
#下载一个其它仓储已经有的项目
helm fetch aliyuncs/mysql
[root@supper test]# ll
-rw-r--r-- 1 root root 17860 Dec 28 23:21 mysql-6.8.0.tgz
#上传到私有仓库
helm push mysql-6.8.0.tgz --ca-file=ca.crt --cert-file=harbor.wzxmt.com.crt --key-file=harbor.wzxmt.com.key --username=admin --password=admin library

Pushing mysql-6.8.0.tgz to library...
Done.
#更新repo
helm repo update
#查找刚刚push mysql
[root@supper ssl]# helm search repo mysql
NAME                                    CHART VERSION   APP VERSION     DESCRIPTION
aliyuncs/mysql                          6.8.0           8.0.19          Chart to create a Highly available MySQL cluster
library/mysql                           6.8.0           8.0.19          Chart to create a Highly available MySQL cluster
myrepo/library/mysql                    6.8.0           8.0.19          Chart to create a Highly available MySQL cluster
```

每次认证比较麻烦，可以关闭helm cahrt认证

```bash
cat << "EOF" >/root/.config/helm/repositories.yaml
apiVersion: ""
generated: "0001-01-01T00:00:00Z"
repositories:
- caFile: "/opt/cert/ca.crt"
  certFile: "/opt/cert/harbor.wzxmt.com.crt"
  insecure_skip_tls_verify: true
  keyFile: "/opt/cert/harbor.wzxmt.com.key"
  name: library
  password: admin
  url: https://harbor.wzxmt.com/chartrepo/library
  username: admin
- caFile: ""
  certFile: ""
  insecure_skip_tls_verify: false
  keyFile: ""
  name: bitnami
  password: ""
  url: https://charts.bitnami.com/bitnami
  username: ""
EOF
```

