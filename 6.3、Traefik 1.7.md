## 部署traefik（ingress）

### 准备traefik镜像

运维主机manege上：

```
[root@manege harbor]# docker pull traefik:v1.7-alpine
v1.7-alpine: Pulling from library/traefik
bdf0201b3a05: Pull complete 
9dfd896cc066: Pull complete 
de06b5685128: Pull complete 
c4d82a21fa27: Pull complete 
Digest: sha256:0531581bde9da0670fc2c7a4e419e1cc38abff74e7ba06410bf2b1b55c70ef15
Status: Downloaded newer image for traefik:v1.7-alpine
[root@manege ~]# docker tag 05cf7f226483 harbor.wzxmt.com/k8s/traefik:v1.7      
[root@manege harbor]# docker push harbor.wzxmt.com/k8s/traefik:v1.7
The push refers to repository [harbor.wzxmt.com/k8s/traefik]
3b290d5924bf: Pushed 
63c8792a9d9e: Pushed 
4dca0fb1912d: Pushed 
3e207b409db3: Pushed 
v1.7: digest: sha256:b577b9f4080e4ef05bee4f07f5d9aee2ae633a0a9625ccfb259a91a51496e3ee size: 1157
```

### 准备资源配置清单

运维主机manege上：

```bash
[root@manege ~]# mkdir -p /data/software/yaml/traefik && cd /data/software/yaml/traefik
```

RBAC

```yaml
cat << EOF >rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  name: traefik-ingress-controller
rules:
  - apiGroups:
      - ""
    resources:
      - services
      - endpoints
      - secrets
    verbs:
      - get
      - list
      - watch
  - apiGroups:
      - extensions
    resources:
      - ingresses
    verbs:
      - get
      - list
      - watch
---
kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: traefik-ingress-controller
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: traefik-ingress-controller
subjects:
- kind: ServiceAccount
  name: traefik-ingress-controller
  namespace: kube-system
EOF
```

daemonset

```yaml
cat << EOF >daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: traefik-ingress-controller
  namespace: kube-system
  labels:
    k8s-app: traefik-ingress-lb
spec:
  selector:    
    matchLabels:      
      k8s-app: traefik-ingress-lb
      name: traefik-ingress-lb
  template:
    metadata:
      labels:
        k8s-app: traefik-ingress-lb
        name: traefik-ingress-lb
    spec:
      serviceAccountName: traefik-ingress-controller
      terminationGracePeriodSeconds: 60
      imagePullSecrets:
        - name: harborlogin
      containers:
      - image: harbor.wzxmt.com/k8s/traefik:v1.7
        name: traefik-ingress-lb
        ports:
        - name: http
          containerPort: 80
        - name: admin
          containerPort: 8080
        securityContext:
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE
        args:
        - --api
        - --kubernetes
        - --logLevel=INFO
        - --insecureskipverify=true
        - --kubernetes.endpoint=https://10.0.0.150:8443
        - --accesslog
        - --accesslog.filepath=/var/log/traefik_access.log
        - --traefiklog
        - --traefiklog.filepath=/var/log/traefik.log
        - --metrics.prometheus
EOF
```

svc

```yaml
cat << EOF >svc.yaml
kind: Service
apiVersion: v1
metadata:
  name: traefik-ingress-service
  namespace: kube-system
spec:
  type: NodePort
  selector:
    k8s-app: traefik-ingress-lb
  ports:
    - protocol: TCP
      port: 80
      name: web
      nodePort: 80
    - protocol: TCP
      port: 8080
      name: admin
EOF
```

ingress

```yaml
cat << EOF >ingress.yaml
apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  name: traefik-web-ui
  namespace: kube-system
  annotations:
    kubernetes.io/ingress.class: traefik
spec:
  rules:
  - host: traefik.wzxmt.com
    http:
      paths:
      - backend:
          serviceName: traefik-ingress-service
          servicePort: 8080
EOF
```

### 解析域名

```
/var/named/wzxmt.com.zone
traefik	60 IN A 10.0.0.20
```

### 依次执行创建

浏览器打开：http://www.wzxmt.com/yaml/traefik/检查资源配置清单文件是否正确创建
在任意运算节点应用资源配置清单

```
kubectl apply -f http://www.wzxmt.com/yaml/traefik/rbac.yaml 
kubectl apply -f http://www.wzxmt.com/yaml/traefik/daemonset.yaml 
kubectl apply -f http://www.wzxmt.com/yaml/traefik/svc.yaml 
kubectl apply -f http://www.wzxmt.com/yaml/traefik/ingress.yaml 
```

### 配置反代

`HDSS7-11.host.com`和`HDSS7-12.host.com`两台主机上的nginx均需要配置，这里可以考虑使用saltstack或者ansible进行统一配置管理

复制

```
cat << 'EOF' >/etc/nginx/conf.d/wzxmt.conf
upstream default_backend_traefik {
    server 10.0.0.31:80    max_fails=3 fail_timeout=10s;
    server 10.0.0.32:80    max_fails=3 fail_timeout=10s;
    server 10.0.0.33:80    max_fails=3 fail_timeout=10s;
}
server {
    server_name *.wzxmt.com;
    location / {
        proxy_pass http://default_backend_traefik;
        proxy_set_header Host       $http_host;
        proxy_set_header x-forwarded-for $proxy_add_x_forwarded_for;
    }
}
EOF
```



### 浏览器访问

[http://traefik.od.com](http://traefik.od.com/)